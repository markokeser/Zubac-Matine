@model Zubac.Models.MakeOrderViewModel

@{
    ViewData["Title"] = "Make Order";

    bool foodEnabled = User.HasClaim("FoodEnabled", "True");
    var foods = Model.Articles.Where(x => x.IsFood).ToList();
    var drinks = Model.Articles.Where(x => !x.IsFood).ToList();
}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container my-4">

    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary mb-3">🏠 Home</a>

    <div class="card p-4 shadow-sm">
        <h2 class="text-center mb-4">📝 Make a New Order</h2>

        <form asp-action="Create" method="post">

            <!-- TABLE NUMBER -->
            <div class="mb-4">
                <label>Table Number</label>
                <select id="tableNumber" name="TableNumber" class="form-control w-100">
                    @for (int i = 1; i <= 20; i++)
                    {
                        <option value="@i">@i</option>
                    }
                </select>
            </div>

            <!-- FOOD SECTION -->
   @if(foodEnabled)
   {
            <div class="border rounded p-3 mb-4">
                <h4 class="mb-3">🍔 Food</h4>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>Select Food</label>
                        <select id="foodSelect" class="form-control">
                            <option value="">Select food</option>
                            @foreach (var f in foods)
                            {
                                <option value="@f.Id" data-name="@f.Name" data-price="@f.Price">
                                    @f.Name (@f.Price.ToString("F2")€)
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label>Quantity</label>
                        <input type="number" id="foodQty" class="form-control" min="1" value="1" />
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-warning w-100" onclick="addFood()">➕ Add Food</button>
                    </div>
                </div>

                <div id="selectedFoodContainer"></div>
            </div>
            }

            <!-- DRINK SECTION -->
            <div class="border rounded p-3 mb-4">
                <h4 class="mb-3">🍺 Drinks</h4>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label>Select Drink</label>
                        <select id="drinkSelect" class="form-control">
                            <option value="">Select drink</option>
                            @foreach (var d in drinks)
                            {
                                <option value="@d.Id" data-name="@d.Name" data-price="@d.Price">
                                    @d.Name (@d.Price.ToString("F2")€)
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label>Quantity</label>
                        <input type="number" id="drinkQty" class="form-control" min="1" value="1" />
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-info w-100" onclick="addDrink()">➕ Add Drink</button>
                    </div>
                </div>

                <div id="selectedDrinkContainer"></div>
            </div>

            <!-- TOTAL -->
            <div class="text-end fw-bold fs-4 mb-3">
                Total: <span id="totalPrice">0.00</span>€
            </div>

            <button type="submit" class="btn btn-success w-100">✅ Submit Order</button>

        </form>
    </div>
</div>

<style>
    .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0.9rem;
        border: 1px solid #ddd;
        background: #fafafa;
        border-radius: 0.35rem;
        margin-bottom: 0.5rem;
    }
</style>

<script>
    $(document).ready(function () {
        $('#tableNumber, #foodSelect, #drinkSelect').select2({ allowClear: true });
    });

    let index = 0;
    let total = 0;

    function addItem(container, selectId, qtyId) {
        const sel = $(selectId).find(':selected');
        const id = sel.val();
        const name = sel.data("name");
        const price = parseFloat(sel.data("price"));
        const qty = parseInt($(qtyId).val());

        if (!id || qty <= 0) return alert("Select item and quantity.");

        const sum = price * qty;
        total += sum;

        const html = `
                <div class="item-row" id="row-${index}">
                    <input type="hidden" name="SelectedArticles[${index}].ArticleId" value="${id}" />
                    <input type="hidden" name="SelectedArticles[${index}].IsSelected" value="true" />
                    <input type="hidden" name="SelectedArticles[${index}].Quantity" value="${qty}" />

                    <span>${name} × ${qty} — ${sum.toFixed(2)}€</span>

                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${index}, ${sum})">🗑 Remove</button>
                </div>
            `;

        $(container).append(html);
        index++;

        $(selectId).val(null).trigger('change');
        $(qtyId).val(1);
        $('#totalPrice').text(total.toFixed(2));
    }

    function addFood() { addItem("#selectedFoodContainer", "#foodSelect", "#foodQty"); }
    function addDrink() { addItem("#selectedDrinkContainer", "#drinkSelect", "#drinkQty"); }

    function removeItem(i, sum) {
        $("#row-" + i).remove();
        total -= sum;
        $('#totalPrice').text(total.toFixed(2));
    }
</script>